# ЧЕК-ЛИСТ: РАЗРАБОТКА АВТОМАТИЗАЦИИ АНАЛИЗА КОНКУРЕНТОВ

**Проект:** Python + Selenium парсер для SEO анализа
**Дата создания:** 22.01.2026
**Версия:** 1.0
**Статус:** Активный документ

---

## ЭТАП 0: ПОДГОТОВКА ОКРУЖЕНИЯ

### 0.1 Установка Python и зависимостей

- [ ] **Проверить версию Python**
  ```bash
  python3 --version  # Должно быть >= 3.11
  ```

- [ ] **Перейти в директорию проекта**
  ```bash
  cd "/Volumes/T7 Shield/SEO для инфобизнеса актуальность, возможности, инструменты/SEO_РАБОТА"
  ```

- [ ] **Создать виртуальное окружение**
  ```bash
  python3 -m venv venv
  ```

- [ ] **Активировать окружение**
  ```bash
  source venv/bin/activate  # macOS/Linux
  ```

- [ ] **Создать requirements.txt**
  ```txt
  # requirements.txt
  selenium==4.17.0
  undetected-chromedriver==3.5.4
  selenium-stealth==1.0.6
  beautifulsoup4==4.12.3
  requests==2.31.0
  pandas==2.2.0
  openpyxl==3.1.2
  python-dotenv==1.0.0
  fake-useragent==1.4.0
  lxml==5.1.0
  ```

- [ ] **Установить зависимости**
  ```bash
  pip install -r requirements.txt
  ```

- [ ] **Проверить установку**
  ```bash
  python -c "import selenium; print(selenium.__version__)"
  python -c "import undetected_chromedriver; print('OK')"
  ```

### 0.2 Настройка Chrome профиля (КРИТИЧНО для обхода защиты Яндекса!)

- [ ] **Найти путь к профилю Chrome**
  ```bash
  # macOS
  ls -la ~/Library/Application\ Support/Google/Chrome/

  # Должны увидеть папки: Default, Profile 1, Profile 2...
  ```

- [ ] **Записать путь к профилю**
  ```
  Мой путь: /Users/ivan/Library/Application Support/Google/Chrome
  Используемый профиль: Default
  ```

- [ ] **Вручную авторизоваться в Яндекс через этот профиль**
  1. Открыть Chrome с нужным профилем
  2. Зайти на yandex.ru
  3. Авторизоваться (если нужно)
  4. Подтвердить регион
  5. Сделать 2-3 реальных поиска вручную
  6. Закрыть браузер

- [ ] **Создать папку для cookies**
  ```bash
  mkdir -p ИНСТРУМЕНТЫ/скрипты/cookies
  ```

### 0.3 Создание структуры проекта

- [ ] **Создать папки**
  ```bash
  mkdir -p ИНСТРУМЕНТЫ/скрипты/{utils,parsers,logs}
  mkdir -p ИНСТРУМЕНТЫ/скрипты/cookies
  touch ИНСТРУМЕНТЫ/скрипты/{config.py,main.py}
  touch ИНСТРУМЕНТЫ/скрипты/utils/{__init__.py,browser.py,selectors.py,helpers.py}
  touch ИНСТРУМЕНТЫ/скрипты/parsers/{__init__.py,yandex_parser.py,content_parser.py,simple_analyzer.py}
  ```

- [ ] **Проверить структуру**
  ```bash
  tree ИНСТРУМЕНТЫ/скрипты/
  ```
  Ожидаемая структура:
  ```
  ИНСТРУМЕНТЫ/скрипты/
  ├── config.py
  ├── main.py
  ├── requirements.txt
  ├── cookies/
  ├── logs/
  ├── utils/
  │   ├── __init__.py
  │   ├── browser.py
  │   ├── selectors.py
  │   └── helpers.py
  └── parsers/
      ├── __init__.py
      ├── yandex_parser.py
      ├── content_parser.py
      └── simple_analyzer.py
  ```

### 0.4 Создание .env файла

- [ ] **Создать .env для конфигурации**
  ```bash
  touch ИНСТРУМЕНТЫ/скрипты/.env
  ```

- [ ] **Заполнить .env**
  ```env
  # .env
  HEADLESS=False
  CHROME_PROFILE=/Users/ivan/Library/Application Support/Google/Chrome
  CHROME_PROFILE_NAME=Default
  YANDEX_COOKIES_PATH=cookies/yandex.pkl
  MIN_DELAY=2
  MAX_DELAY=5
  LOG_LEVEL=INFO
  ```

- [ ] **Добавить .env в .gitignore**
  ```bash
  echo ".env" >> .gitignore
  echo "cookies/" >> .gitignore
  echo "logs/" >> .gitignore
  echo "venv/" >> .gitignore
  ```

---

## ЭТАП 1: РАЗРАБОТКА БАЗОВЫХ МОДУЛЕЙ

### 1.1 Конфигурация (config.py)

- [ ] **Создать config.py**
  ```python
  # ИНСТРУМЕНТЫ/скрипты/config.py
  from dotenv import load_dotenv
  import os
  from pathlib import Path

  # Загрузка переменных окружения
  load_dotenv()

  # Базовые пути
  BASE_DIR = Path(__file__).parent
  COOKIES_DIR = BASE_DIR / "cookies"
  LOGS_DIR = BASE_DIR / "logs"

  # Создание директорий если не существуют
  COOKIES_DIR.mkdir(exist_ok=True)
  LOGS_DIR.mkdir(exist_ok=True)

  class Config:
      # Браузер
      HEADLESS = os.getenv("HEADLESS", "False") == "True"
      CHROME_PROFILE = os.getenv("CHROME_PROFILE", "")
      CHROME_PROFILE_NAME = os.getenv("CHROME_PROFILE_NAME", "Default")

      # Яндекс
      YANDEX_COOKIES_PATH = COOKIES_DIR / "yandex.pkl"

      # Задержки (антибот)
      MIN_DELAY = int(os.getenv("MIN_DELAY", "2"))
      MAX_DELAY = int(os.getenv("MAX_DELAY", "5"))

      # Логирование
      LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
      LOG_FILE = LOGS_DIR / "scraper.log"

      # User-Agent
      USER_AGENT = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"
  ```

- [ ] **Протестировать config.py**
  ```bash
  python -c "from config import Config; print(Config.CHROME_PROFILE)"
  ```

### 1.2 Инициализация браузера (utils/browser.py)

- [ ] **Создать utils/browser.py**
  ```python
  # ИНСТРУМЕНТЫ/скрипты/utils/browser.py
  import undetected_chromedriver as uc
  from selenium_stealth import stealth
  import pickle
  import logging
  from pathlib import Path
  from config import Config

  logger = logging.getLogger(__name__)

  def init_driver(headless: bool = False):
      """
      Инициализирует undetected Chrome driver

      Args:
          headless: Запускать в headless режиме (НЕ рекомендуется для Яндекса!)

      Returns:
          WebDriver instance
      """
      try:
          options = uc.ChromeOptions()

          # КРИТИЧНО: Использование реального профиля Chrome
          if Config.CHROME_PROFILE:
              options.add_argument(f"--user-data-dir={Config.CHROME_PROFILE}")
              options.add_argument(f"--profile-directory={Config.CHROME_PROFILE_NAME}")
              logger.info(f"Используется профиль: {Config.CHROME_PROFILE}/{Config.CHROME_PROFILE_NAME}")

          # Headless mode (не рекомендуется для Яндекса)
          if headless:
              options.add_argument("--headless=new")
              logger.warning("Headless режим включен - возможны проблемы с антиботом!")

          # Отключение автоматизации флагов
          options.add_argument("--disable-blink-features=AutomationControlled")
          options.add_experimental_option("excludeSwitches", ["enable-automation"])
          options.add_experimental_option('useAutomationExtension', False)

          # Инициализация драйвера
          driver = uc.Chrome(options=options, version_main=120)

          # Применение stealth
          stealth(driver,
              languages=["ru-RU", "ru"],
              vendor="Google Inc.",
              platform="MacIntel",
              webgl_vendor="Intel Inc.",
              renderer="Intel Iris OpenGL Engine",
              fix_hairline=True,
          )

          # Дополнительная маскировка через CDP
          driver.execute_cdp_cmd("Page.addScriptToEvaluateOnNewDocument", {
              "source": """
                  Object.defineProperty(navigator, 'webdriver', {get: () => undefined});
                  Object.defineProperty(navigator, 'plugins', {get: () => [1, 2, 3, 4, 5]});
                  window.chrome = {runtime: {}};
              """
          })

          logger.info("Драйвер успешно инициализирован")
          return driver

      except Exception as e:
          logger.error(f"Ошибка инициализации драйвера: {e}")
          raise

  def save_cookies(driver, filepath: Path = Config.YANDEX_COOKIES_PATH):
      """Сохранить cookies в файл"""
      try:
          with open(filepath, 'wb') as f:
              pickle.dump(driver.get_cookies(), f)
          logger.info(f"Cookies сохранены в {filepath}")
      except Exception as e:
          logger.error(f"Ошибка сохранения cookies: {e}")

  def load_cookies(driver, filepath: Path = Config.YANDEX_COOKIES_PATH):
      """Загрузить cookies из файла"""
      try:
          if not filepath.exists():
              logger.warning(f"Файл cookies не найден: {filepath}")
              return False

          # Открыть Яндекс перед загрузкой cookies
          driver.get("https://yandex.ru")

          with open(filepath, 'rb') as f:
              cookies = pickle.load(f)
              for cookie in cookies:
                  # Удалить expiry если есть (иногда вызывает проблемы)
                  if 'expiry' in cookie:
                      del cookie['expiry']
                  driver.add_cookie(cookie)

          driver.refresh()
          logger.info(f"Cookies загружены из {filepath}")
          return True

      except Exception as e:
          logger.error(f"Ошибка загрузки cookies: {e}")
          return False
  ```

- [ ] **Протестировать browser.py**
  ```python
  # Тест
  from utils.browser import init_driver, load_cookies

  driver = init_driver()
  load_cookies(driver)
  driver.get("https://yandex.ru")
  input("Проверь, что Яндекс загрузился. Enter для продолжения...")
  driver.quit()
  ```

### 1.3 Селекторы (utils/selectors.py)

- [ ] **Создать utils/selectors.py**
  ```python
  # ИНСТРУМЕНТЫ/скрипты/utils/selectors.py

  class YandexSelectors:
      """CSS селекторы для Яндекс поиска"""

      # Результаты поиска
      SERP_ITEM = ".serp-item"
      SERP_ITEM_ALT = "[data-cid]"

      # Ссылка результата
      RESULT_LINK = "a.link"
      RESULT_LINK_ALT = ".organic__url"

      # Реклама (для фильтрации)
      AD_MARKERS = [
          ".label_theme_direct",
          ".serp-adv__item",
          "[data-fast-name='direct']"
      ]

      # Видео (для фильтрации)
      VIDEO_MARKERS = [
          ".serp-item_type_video",
          ".video-thumb"
      ]

  class ArticleSelectors:
      """CSS селекторы для статей"""

      # Заголовок H1 (множественные варианты)
      TITLE_SELECTORS = [
          'h1',
          '.title',
          '.article-title',
          '.post-title',
          '.entry-title',
          '[itemprop="headline"]'
      ]

      # Подзаголовки
      HEADINGS = ['h2', 'h3']

      # Теги для удаления (мусор)
      UNWANTED_TAGS = [
          'script', 'style', 'nav', 'footer', 'header',
          'aside', 'iframe', 'noscript', 'svg', 'form'
      ]

      # Классы для удаления (реклама)
      UNWANTED_CLASS_KEYWORDS = [
          'ad', 'advertisement', 'banner', 'sidebar',
          'comment', 'related', 'social', 'share', 'popup'
      ]
  ```

### 1.4 Вспомогательные функции (utils/helpers.py)

- [ ] **Создать utils/helpers.py**
  ```python
  # ИНСТРУМЕНТЫ/скрипты/utils/helpers.py
  import time
  import random
  import logging
  from config import Config

  logger = logging.getLogger(__name__)

  def random_delay(min_sec: int = None, max_sec: int = None):
      """Случайная задержка для имитации человеческого поведения"""
      min_sec = min_sec or Config.MIN_DELAY
      max_sec = max_sec or Config.MAX_DELAY

      delay = random.uniform(min_sec, max_sec)
      logger.debug(f"Задержка {delay:.2f} сек")
      time.sleep(delay)

  def safe_extract_text(element, default: str = ""):
      """Безопасное извлечение текста из элемента"""
      try:
          return element.get_text(strip=True) if element else default
      except:
          return default

  def clean_url(url: str) -> str:
      """Очистка URL от параметров отслеживания"""
      if '?' in url:
          return url.split('?')[0]
      return url
  ```

---

## ЭТАП 2: РАЗРАБОТКА ПАРСЕРОВ

### 2.1 Парсер Яндекс поиска (parsers/yandex_parser.py)

- [ ] **Создать yandex_parser.py**
  ```python
  # ИНСТРУМЕНТЫ/скрипты/parsers/yandex_parser.py
  from selenium.webdriver.common.by import By
  from selenium.webdriver.support.ui import WebDriverWait
  from selenium.webdriver.support import expected_conditions as EC
  import logging
  from typing import List
  from utils.selectors import YandexSelectors
  from utils.helpers import random_delay
  import urllib.parse

  logger = logging.getLogger(__name__)

  def get_top_urls(driver, keyword: str, count: int = 10) -> List[str]:
      """
      Получить ТОП-N URL из Яндекс поиска

      Args:
          driver: Selenium WebDriver
          keyword: Ключевой запрос
          count: Количество результатов

      Returns:
          Список URL статей
      """
      try:
          # Формирование URL поиска
          encoded_keyword = urllib.parse.quote(keyword)
          search_url = f"https://yandex.ru/search/?text={encoded_keyword}"

          logger.info(f"Поиск по запросу: '{keyword}'")
          driver.get(search_url)

          # Случайная задержка (имитация человека)
          random_delay(3, 5)

          # Ожидание загрузки результатов
          wait = WebDriverWait(driver, 10)
          wait.until(
              lambda d: len(d.find_elements(By.CSS_SELECTOR, YandexSelectors.SERP_ITEM)) >= 5
          )

          # Скролл для подгрузки всех результатов
          driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
          random_delay(2, 3)

          # Получение всех результатов поиска
          results = driver.find_elements(By.CSS_SELECTOR, YandexSelectors.SERP_ITEM)
          logger.info(f"Найдено {len(results)} результатов")

          urls = []
          for result in results:
              try:
                  # Пропуск рекламы
                  is_ad = any(
                      result.find_elements(By.CSS_SELECTOR, marker)
                      for marker in YandexSelectors.AD_MARKERS
                  )
                  if is_ad:
                      logger.debug("Пропуск рекламы")
                      continue

                  # Пропуск видео
                  is_video = any(
                      result.find_elements(By.CSS_SELECTOR, marker)
                      for marker in YandexSelectors.VIDEO_MARKERS
                  )
                  if is_video:
                      logger.debug("Пропуск видео")
                      continue

                  # Извлечение URL
                  link_element = result.find_element(By.CSS_SELECTOR, YandexSelectors.RESULT_LINK)
                  url = link_element.get_attribute("href")

                  if url and url.startswith("http"):
                      urls.append(url)
                      logger.info(f"[{len(urls)}] {url}")

                  if len(urls) >= count:
                      break

              except Exception as e:
                  logger.warning(f"Ошибка обработки результата: {e}")
                  continue

          logger.info(f"Собрано {len(urls)} URL")
          return urls[:count]

      except Exception as e:
          logger.error(f"Ошибка парсинга Яндекса: {e}")
          return []
  ```

- [ ] **Протестировать yandex_parser.py**
  ```python
  # Тест
  from utils.browser import init_driver, load_cookies
  from parsers.yandex_parser import get_top_urls

  driver = init_driver()
  load_cookies(driver)
  urls = get_top_urls(driver, "почему не худею", count=5)
  print(f"\nНайдено {len(urls)} URL:")
  for i, url in enumerate(urls, 1):
      print(f"{i}. {url}")
  driver.quit()
  ```

### 2.2 Парсер контента статей (parsers/content_parser.py)

- [ ] **Создать content_parser.py** (код в следующей секции из-за лимита символов)

### 2.3 Простой анализатор (parsers/simple_analyzer.py)

- [ ] **Создать simple_analyzer.py**

---

## ЭТАП 3: ТЕСТИРОВАНИЕ КОМПОНЕНТОВ

### 3.1 Тестирование парсера Яндекса

- [ ] **Тест 1: Получение 5 URL**
  - [ ] Запустить скрипт
  - [ ] Проверить, что получено 5 URL
  - [ ] Проверить, что нет рекламы
  - [ ] Проверить, что нет видео

- [ ] **Тест 2: Обработка ошибок**
  - [ ] Тест с несуществующим запросом
  - [ ] Тест с пустым запросом
  - [ ] Проверить логи ошибок

### 3.2 Тестирование парсера контента

- [ ] **Тест 1: Извлечение данных**
  - [ ] Протестировать на 3 разных сайтах
  - [ ] Проверить извлечение H1
  - [ ] Проверить извлечение подзаголовков
  - [ ] Проверить подсчет символов

- [ ] **Тест 2: Обработка edge cases**
  - [ ] Сайт без H1
  - [ ] Сайт с защитой Cloudflare
  - [ ] Недоступный сайт (404)

---

## ЭТАП 4: ИНТЕГРАЦИЯ И ФИНАЛИЗАЦИЯ

### 4.1 Главный скрипт (main.py)

- [ ] **Создать main.py с CLI интерфейсом**
- [ ] **Добавить обработку аргументов командной строки**
- [ ] **Добавить progress bar**
- [ ] **Добавить сохранение в Excel**

### 4.2 Финальное тестирование

- [ ] **Тест полного цикла на ключе "почему не худею"**
  ```bash
  python main.py "почему не худею"
  ```
- [ ] **Проверить созданный Excel файл**
- [ ] **Проверить логи**

---

## КРИТИЧЕСКИЕ ПРОВЕРКИ ПЕРЕД ЗАПУСКОМ

**ПЕРЕД КАЖДЫМ ЗАПУСКОМ ПРОВЕРИТЬ:**

- [ ] ✅ Chrome профиль настроен
- [ ] ✅ Cookies Яндекса сохранены и актуальны (обновлять раз в 7 дней)
- [ ] ✅ Виртуальное окружение активировано
- [ ] ✅ Все зависимости установлены
- [ ] ✅ HEADLESS=False (для обхода защиты)
- [ ] ✅ Задержки MIN_DELAY >= 2 секунд
- [ ] ✅ Папки logs/ и cookies/ существуют

**ЕСЛИ ЯНДЕКС БЛОКИРУЕТ:**

- [ ] Проверить, используется ли undetected-chromedriver
- [ ] Проверить, загружен ли реальный Chrome профиль
- [ ] Проверить, актуальны ли cookies
- [ ] Увеличить задержки (MIN_DELAY=5, MAX_DELAY=10)
- [ ] Вручную авторизоваться в Chrome профиле снова

---

**СТАТУС ВЫПОЛНЕНИЯ:** 0% → будет обновляться по мере разработки

**СЛЕДУЮЩИЙ ШАГ:** Начать с Этапа 0 (Подготовка окружения)
