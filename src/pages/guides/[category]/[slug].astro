---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const guides = await getCollection('guides');
  return guides.map((guide) => {
    // Slug в Astro включает подпапку: "seo/kak-rabotaet-seo"
    // Нам нужна только часть после категории
    const slugParts = guide.slug.split('/');
    const fileName = slugParts[slugParts.length - 1];
    return {
      params: { category: guide.data.category, slug: fileName },
      props: { guide },
    };
  });
}

const { guide } = Astro.props;
const { Content } = await guide.render();

// Соседние уроки для навигации
const allGuides = await getCollection('guides');
const categoryGuides = allGuides
  .filter((g) => g.data.category === guide.data.category)
  .sort((a, b) => a.data.order - b.data.order);

const currentIndex = categoryGuides.findIndex((g) => g.slug === guide.slug);
const prevGuide = currentIndex > 0 ? categoryGuides[currentIndex - 1] : null;
const nextGuide = currentIndex < categoryGuides.length - 1 ? categoryGuides[currentIndex + 1] : null;

function getSlugFileName(slug: string) {
  const parts = slug.split('/');
  return parts[parts.length - 1];
}

const categoryTitles: Record<string, string> = {
  seo: 'SEO-продвижение',
  funnels: 'Воронки продаж',
  monetization: 'Монетизация',
  'ai-tools': 'ИИ-инструменты',
};

const categoryTitle = categoryTitles[guide.data.category] ?? guide.data.category;

const canonicalURL = new URL(
  `/guides/${guide.data.category}/${Astro.params.slug}/`,
  Astro.site
);

const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": guide.data.title,
  "description": guide.data.description,
  "author": {
    "@type": "Person",
    "name": "Артём Воронов",
    "url": "https://app.leadfunnel.online/about/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ВоронщикPro",
    "url": "https://app.leadfunnel.online"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalURL.toString()
  },
  "inLanguage": "ru-RU",
  ...(guide.data.pubDate ? { "datePublished": guide.data.pubDate.toISOString() } : {}),
};
---

<Layout
  title={`${guide.data.title} | ВоронщикPro`}
  description={guide.data.description}
>
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(articleSchema)} />
  <div class="max-w-3xl mx-auto px-4 py-12">

    <!-- Назад к разделу -->
    <a
      href={`/guides/${guide.data.category}/`}
      class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-white transition-colors mb-8 border border-border rounded-md px-3 py-1.5"
    >
      ← {categoryTitle}
    </a>

    <!-- Лейбл модуля + дата -->
    <div class="flex items-center gap-4 mb-3">
      <p class="text-xs text-gray-500 tracking-wide">
        Модуль {guide.data.module}: {guide.data.moduleTitle}
      </p>
      {guide.data.pubDate && (
        <time datetime={guide.data.pubDate.toISOString()} class="text-xs text-gray-500">
          {guide.data.pubDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}
        </time>
      )}
    </div>

    <!-- Заголовок -->
    <h1 class="text-3xl font-bold text-white mb-8">{guide.data.title}</h1>

    <!-- Разделитель -->
    <div class="border-t border-border mb-8"></div>

    <!-- Контент -->
    <div class="prose">
      <Content />
    </div>

    <!-- Разделитель -->
    <div class="border-t border-border mt-12 mb-8"></div>

    <!-- Навигация предыдущий / следующий -->
    <div class="flex items-center justify-between gap-4">
      {prevGuide ? (
        <a
          href={`/guides/${prevGuide.data.category}/${getSlugFileName(prevGuide.slug)}/`}
          class="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition-colors group"
        >
          <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          <span class="group-hover:underline">{prevGuide.data.title}</span>
        </a>
      ) : (
        <div></div>
      )}

      {nextGuide ? (
        <a
          href={`/guides/${nextGuide.data.category}/${getSlugFileName(nextGuide.slug)}/`}
          class="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition-colors group text-right"
        >
          <span class="group-hover:underline">{nextGuide.data.title}</span>
          <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </a>
      ) : (
        <div></div>
      )}
    </div>

  </div>
</Layout>
